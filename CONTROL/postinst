#!/bin/sh

# BackupSuite post-installation script
# Version: 3.0-r9
# Author: BackupSuite Team

set -e  # Exit on any error

SCRIPT_NAME="backupsuite-postinst"
INSTALL_PATH="/usr/lib/enigma2/python/Plugins/Extensions/BackupSuite"
LOG_FILE="/tmp/backupsuite_install.log"

# Logging function
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# Error handling function
error_exit() {
    log_message "ERROR: $1"
    exit 1
}

# Check if running as root
check_privileges() {
    if [ "$(id -u)" -ne 0 ]; then
        error_exit "This script must be run as root"
    fi
}

# Validate installation directory
validate_installation() {
    if [ ! -d "$INSTALL_PATH" ]; then
        error_exit "Installation directory not found: $INSTALL_PATH"
    fi
    
    if [ ! -f "$INSTALL_PATH/backupusb.sh" ]; then
        error_exit "Core backup scripts not found in $INSTALL_PATH"
    fi
}

# Set executable permissions
set_permissions() {
    log_message "Setting executable permissions for backup scripts..."
    
    # Find and make all shell scripts executable
    find "$INSTALL_PATH" -name "*.sh" -type f | while read -r script; do
        if [ -f "$script" ]; then
            chmod 755 "$script"
            log_message "Set permissions for: $(basename "$script")"
        fi
    done
    
    # Count scripts processed
    script_count=$(find "$INSTALL_PATH" -name "*.sh" -type f | wc -l)
    log_message "Processed $script_count backup scripts"
}

# Restart Enigma2 gracefully
restart_enigma2() {
    log_message "Initiating Enigma2 restart sequence..."
    
    # Stop Enigma2 gracefully
    init 4